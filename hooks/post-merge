#!/bin/bash
# Git post-merge hook
# 自动在 git pull 后重新标记团队文件夹

# 检查是否有保存的团队配置
TEAM_CONFIG=".git/team-config"

if [ ! -f "$TEAM_CONFIG" ]; then
    # 如果没有配置，静默退出
    exit 0
fi

# 读取配置的团队
MY_TEAM=$(cat "$TEAM_CONFIG")

if [ -z "$MY_TEAM" ]; then
    exit 0
fi

# 获取所有团队文件夹
TEAM_FOLDERS=($(ls -d */ 2>/dev/null | grep "^team" | sed 's|/||'))

if [ ${#TEAM_FOLDERS[@]} -eq 0 ]; then
    exit 0
fi

# 【新增】检查并自动解决合并冲突
if [ -f .git/MERGE_HEAD ]; then
    echo "⚠️  检测到冲突，自动解决..."

    # 对不是本团队的文件夹，使用远程版本覆盖
    for team in "${TEAM_FOLDERS[@]}"; do
        if [ "$team" != "$MY_TEAM" ]; then
            # 检查该团队文件夹是否有冲突文件
            CONFLICT_FILES=$(git diff --name-only --diff-filter=U 2>/dev/null | grep "^$team/")

            if [ -n "$CONFLICT_FILES" ]; then
                # 使用远程版本覆盖本地修改
                echo "$CONFLICT_FILES" | while read file; do
                    git checkout --theirs "$file" 2>/dev/null || true
                    git add "$file" 2>/dev/null || true
                done
            fi
        fi
    done

    # 检查是否所有冲突都已解决
    REMAINING_CONFLICTS=$(git diff --name-only --diff-filter=U 2>/dev/null)
    if [ -z "$REMAINING_CONFLICTS" ]; then
        echo "✅ 冲突已自动解决"
        # 自动提交合并结果
        git commit --no-edit 2>/dev/null || true
    else
        echo "⚠️  部分冲突需要手动解决"
    fi
fi

# 清除所有 skip-worktree 标记
# 跨平台兼容：不使用 -r 选项，通过 if 判断处理空输入
SKIP_FILES=$(git ls-files -v | grep ^S | cut -c3-)
if [ -n "$SKIP_FILES" ]; then
    echo "$SKIP_FILES" | xargs git update-index --no-skip-worktree 2>/dev/null || true
fi

# 重新标记其他团队的文件夹
for team in "${TEAM_FOLDERS[@]}"; do
    if [ "$team" != "$MY_TEAM" ]; then
        find "$team" -type f -exec git update-index --skip-worktree {} \; 2>/dev/null || true
    fi
done

echo "✅ 同步完成"
